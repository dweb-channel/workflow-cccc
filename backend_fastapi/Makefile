.PHONY: dev stop worker api temporal logs clean help

# é»˜è®¤ç›®æ ‡
help:
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo "  make dev      - å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆTemporal + Worker + FastAPIï¼‰"
	@echo "  make stop     - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make temporal - ä»…å¯åŠ¨ Temporal Server"
	@echo "  make worker   - ä»…å¯åŠ¨ Worker"
	@echo "  make api      - ä»…å¯åŠ¨ FastAPI"
	@echo "  make logs     - æŸ¥çœ‹åå°æœåŠ¡æ—¥å¿—"
	@echo "  make clean    - æ¸…ç†æ—¥å¿—æ–‡ä»¶"

# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
dev:
	@echo "ğŸš€ å¯åŠ¨ Temporal Server..."
	@temporal server start-dev > /tmp/temporal.log 2>&1 &
	@sleep 3
	@echo "âš™ï¸  å¯åŠ¨ Worker..."
	@.venv/bin/python -m workflow.run_worker > /tmp/worker.log 2>&1 &
	@sleep 1
	@echo "ğŸŒ å¯åŠ¨ FastAPIï¼ˆCtrl+C åœæ­¢æ‰€æœ‰æœåŠ¡ï¼‰..."
	@.venv/bin/uvicorn app.main:app --reload --port 8000 || make stop

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "åœæ­¢æœåŠ¡..."
	@pkill -f "temporal server" 2>/dev/null || true
	@pkill -f "workflow.run_worker" 2>/dev/null || true
	@pkill -f "uvicorn app.main:app" 2>/dev/null || true
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# ä»…å¯åŠ¨ Temporal
temporal:
	@echo "ğŸš€ å¯åŠ¨ Temporal Server..."
	@temporal server start-dev

# ä»…å¯åŠ¨ Worker
worker:
	@echo "âš™ï¸  å¯åŠ¨ Worker..."
	@.venv/bin/python -m workflow.run_worker

# ä»…å¯åŠ¨ FastAPI
api:
	@echo "ğŸŒ å¯åŠ¨ FastAPI..."
	@.venv/bin/uvicorn app.main:app --reload --port 8000

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "=== Temporal æ—¥å¿— ==="
	@tail -20 /tmp/temporal.log 2>/dev/null || echo "(æ— æ—¥å¿—)"
	@echo ""
	@echo "=== Worker æ—¥å¿— ==="
	@tail -20 /tmp/worker.log 2>/dev/null || echo "(æ— æ—¥å¿—)"

# æ¸…ç†æ—¥å¿—
clean:
	@rm -f /tmp/temporal.log /tmp/worker.log
	@echo "âœ… æ—¥å¿—å·²æ¸…ç†"
