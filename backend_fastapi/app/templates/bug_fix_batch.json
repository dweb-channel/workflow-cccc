{
  "name": "batch_bug_fix_workflow",
  "description": "批量 Bug 修复工作流：串行处理多个 Bug，支持重试机制",
  "version": "2.4.0",
  "max_iterations": 100,
  "nodes": [
    {
      "id": "input_node",
      "type": "data_source",
      "config": {
        "name": "Bug 列表输入",
        "description": "接收 Bug URL 列表和配置参数",
        "schema": {
          "type": "object",
          "properties": {
            "bugs": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Jira Bug URL 列表"
            },
            "bugs_count": {
              "type": "integer",
              "description": "Bug 总数 (由调用方设置)"
            },
            "config": {
              "type": "object",
              "properties": {
                "validation_level": { "type": "string", "enum": ["minimal", "standard", "thorough"] },
                "failure_policy": { "type": "string", "enum": ["stop", "skip", "retry"] },
                "max_retries": { "type": "integer", "minimum": 1, "maximum": 10 }
              }
            },
            "cwd": { "type": "string", "description": "Working directory for Claude CLI" },
            "job_id": { "type": "string" }
          },
          "required": ["bugs", "bugs_count", "job_id"]
        },
        "defaults": {
          "current_index": 0,
          "retry_count": 0,
          "results": [],
          "context": {},
          "config": {
            "validation_level": "standard",
            "failure_policy": "skip",
            "max_retries": 3
          }
        }
      }
    },
    {
      "id": "get_current_bug",
      "type": "get_current_item",
      "config": {
        "name": "获取当前 Bug",
        "array_field": "bugs",
        "index_field": "current_index",
        "output_key": "current_bug"
      }
    },
    {
      "id": "fix_bug_peer",
      "type": "llm_agent",
      "config": {
        "name": "修复 Bug",
        "system_prompt": "你是一个高效的 Bug 修复工程师。严格遵循以下规则：\n1. 先通过 Jira URL 获取 Bug 的标题、描述和相关信息\n2. **重要：忽略 Jira 上的 Bug 状态（无论是 open、closed、已验证关闭等）。你的任务是在当前代码分支上修复这个 Bug，不管 Jira 状态如何。**\n3. **不要检查其他 git 分支的代码。只在当前分支的当前代码上工作。**\n4. 根据 Bug 描述直接定位相关文件，不要全局搜索整个代码库\n5. 只修改必要的文件，保持改动最小化\n6. 修复完成后运行相关测试确认无误\n7. **如果无法访问 Jira URL（网络错误、域名无法解析、返回非200状态码等），必须立即停止并使用以下格式报告错误（不要重试访问）：**\n\n## 根因分析\nJira URL 不可达: <具体错误原因>\n## 修改摘要\n无修改（无法获取 Bug 描述信息）\n## 测试结果\n失败 - Jira URL 不可达，无法执行修复\n\n8. 正常情况下，最后必须输出修改摘要（严格按此格式）：\n\n## 根因分析\n<一句话描述问题原因>\n## 修改摘要\n- 文件: <path> | 修改: <一句话描述>\n- 文件: <path> | 修改: <一句话描述>\n## 测试结果\n<通过/失败 + 简要说明>",
        "prompt": "修复以下 Bug：\n\nJira URL: {current_bug}\n\n**重要提示：**\n- 无论 Jira 上显示什么状态（即使是「已关闭」或「已验证关闭」），你必须在当前代码上执行修复\n- 当前分支就是目标修复分支，不要切换或查看其他分支\n- 请先获取 Bug 详情（标题和描述），然后直接在当前代码中定位问题文件并修复\n\n不要浪费时间探索无关代码。\n\n## 历史尝试记录\n{context.retry_history}\n\n如果这是重试（retry_count={retry_count}），上次验证反馈：{context.verify_feedback}",
        "cwd": "{cwd}",
        "timeout": 900
      }
    },
    {
      "id": "verify_fix",
      "type": "verify",
      "config": {
        "name": "验证修复结果",
        "verify_type": "llm_agent",
        "system_prompt": "你是一个代码审查工程师。你的任务是验证 Bug 修复是否正确。\n规则：\n1. 阅读修复摘要，了解改了什么\n2. 检查修改的文件，确认改动合理\n3. 运行相关测试\n4. 最终回复 VERIFIED 或 FAILED（必须包含这个关键词）",
        "prompt_template": "验证以下 Bug 修复：\n\nBug URL: {current_bug}\n\n## 修复摘要（精简版）\n{context.fix_summary}\n\n请执行以下检查：\n1. 查看修复摘要中提到的文件，确认修改是否合理\n2. 运行相关测试（如果有）\n3. 检查是否引入新问题\n\n回复 VERIFIED（验证通过）或 FAILED + 失败原因。",
        "cwd": "{cwd}",
        "timeout": 300
      }
    },
    {
      "id": "check_verify_result",
      "type": "condition",
      "config": {
        "name": "检查验证结果",
        "condition": "verify_fix.verified == True",
        "true_branch": "update_success",
        "false_branch": "check_retry"
      }
    },
    {
      "id": "check_retry",
      "type": "condition",
      "config": {
        "name": "检查重试",
        "description": "检查是否可以重试（retry_count < max_retries）",
        "condition": "retry_count < 3",
        "true_branch": "increment_retry",
        "false_branch": "update_failure"
      }
    },
    {
      "id": "increment_retry",
      "type": "update_state",
      "config": {
        "name": "增加重试计数",
        "updates": [
          {"field": "retry_count", "expression": "retry_count + 1"}
        ]
      }
    },
    {
      "id": "update_failure",
      "type": "update_state",
      "config": {
        "name": "记录失败",
        "updates": [
          {
            "field": "results",
            "append": {
              "url": "{current_bug}",
              "status": "failed",
              "error": "{fix_bug_peer.result}",
              "retries": "{retry_count}"
            }
          },
          {"field": "current_index", "expression": "current_index + 1"},
          {"field": "retry_count", "value": 0},
          {"field": "context", "value": {}}
        ]
      }
    },
    {
      "id": "update_success",
      "type": "update_state",
      "config": {
        "name": "记录成功",
        "updates": [
          {
            "field": "results",
            "append": {
              "url": "{current_bug}",
              "status": "completed",
              "result": "{fix_bug_peer.result}"
            }
          },
          {"field": "current_index", "expression": "current_index + 1"},
          {"field": "retry_count", "value": 0},
          {"field": "context", "value": {}}
        ]
      }
    },
    {
      "id": "check_more_bugs",
      "type": "condition",
      "config": {
        "name": "检查剩余 Bug",
        "description": "检查是否还有更多 Bug 需要处理",
        "condition": "current_index < bugs_count",
        "true_branch": "get_current_bug",
        "false_branch": "output_node"
      }
    },
    {
      "id": "output_node",
      "type": "output",
      "config": {
        "name": "输出结果",
        "description": "输出批量修复的最终结果",
        "format": "json",
        "include_fields": ["job_id", "results", "bugs_count"]
      }
    }
  ],
  "edges": [
    {
      "id": "e1",
      "source": "input_node",
      "target": "get_current_bug"
    },
    {
      "id": "e2",
      "source": "get_current_bug",
      "target": "fix_bug_peer"
    },
    {
      "id": "e3",
      "source": "fix_bug_peer",
      "target": "verify_fix"
    },
    {
      "id": "e3b",
      "source": "verify_fix",
      "target": "check_verify_result"
    },
    {
      "id": "e4_success",
      "source": "check_verify_result",
      "target": "update_success",
      "condition": "condition_result == True"
    },
    {
      "id": "e4_fail",
      "source": "check_verify_result",
      "target": "check_retry",
      "condition": "condition_result == False"
    },
    {
      "id": "e5_retry",
      "source": "check_retry",
      "target": "increment_retry",
      "condition": "condition_result == True"
    },
    {
      "id": "e5_give_up",
      "source": "check_retry",
      "target": "update_failure",
      "condition": "condition_result == False"
    },
    {
      "id": "e5b_back_to_fix",
      "source": "increment_retry",
      "target": "fix_bug_peer"
    },
    {
      "id": "e6",
      "source": "update_failure",
      "target": "check_more_bugs"
    },
    {
      "id": "e6b",
      "source": "update_success",
      "target": "check_more_bugs"
    },
    {
      "id": "e7_continue",
      "source": "check_more_bugs",
      "target": "get_current_bug",
      "condition": "condition_result == True"
    },
    {
      "id": "e7_done",
      "source": "check_more_bugs",
      "target": "output_node",
      "condition": "condition_result == False"
    }
  ],
  "entry_point": "input_node",
  "metadata": {
    "author": "domain-expert",
    "created_at": "2026-02-05",
    "updated_at": "2026-02-05",
    "version_history": [
      {"version": "1.0.0", "date": "2026-02-05", "changes": "Initial template design"},
      {"version": "1.1.0", "date": "2026-02-05", "changes": "Replaced placeholder nodes with get_current_item and update_state"},
      {"version": "1.2.0", "date": "2026-02-05", "changes": "Added VerifyNode with cccc_peer mode for independent verification"},
      {"version": "1.3.0", "date": "2026-02-08", "changes": "Added dynamic peer selection via fixer_peer_id and verifier_peer_id variables"},
      {"version": "2.0.0", "date": "2026-02-11", "changes": "Removed CCCC integration; replaced cccc_peer with llm_agent (Claude CLI direct calls)"},
      {"version": "2.1.0", "date": "2026-02-11", "changes": "Optimized fix/verify prompts: system_prompt constraints, structured output format, retry context injection"},
      {"version": "2.2.0", "date": "2026-02-11", "changes": "Context Accumulator: structured context field for cross-node information passing, verify uses fix_summary instead of full output"},
      {"version": "2.3.0", "date": "2026-02-11", "changes": "Fix prompt: explicitly ignore Jira ticket status, prevent branch switching, force fix on current code"},
      {"version": "2.4.0", "date": "2026-02-12", "changes": "Add structured error handling for unreachable Jira URLs; detect empty fix results in LLMAgentNode"}
    ],
    "tags": ["bug-fix", "batch", "claude-cli", "context-accumulator"],
    "implementation_notes": {
      "completed": "v2.2 Context Accumulator: fix writes fix_summary/retry_history, verify reads summary instead of full output",
      "optional_script_mode": "verify_fix 节点当前使用 llm_agent 模式，可切换为 script 模式运行本地测试"
    },
    "workflow_loops": [
      {
        "name": "main_loop",
        "description": "主循环：遍历 bugs 数组",
        "path": "get_current_bug -> fix_bug_peer -> verify_fix -> update_success/update_failure -> check_more_bugs -> get_current_bug",
        "exit_condition": "current_index >= bugs_count"
      },
      {
        "name": "retry_loop",
        "description": "重试循环：修复失败时重试",
        "path": "fix_bug_peer -> verify_fix -> check_retry -> increment_retry -> fix_bug_peer",
        "exit_condition": "fix_bug_peer.success == True 或 retry_count >= 3"
      }
    ]
  }
}
